@model DocumentIndexViewModel

<div class="container-fluid mt-4">

    <div class="d-flex justify-content-between align-items-center mb-4 pb-2 border-bottom header-area">
       
        <h3 class="text-accent fw-bold page-title">
            <a asp-controller="Folder" asp-action="Index" class="text-decoration-none">
                <i class="fas fa-folder-open me-2 text-warning"></i>@Model.FolderName Documents
            </a>
        </h3>

        <a asp-action="Upload" asp-route-folderId="@Model.FolderId" class="btn btn-primary btn-upload-doc shadow-sm">
            <i class="fas fa-upload me-1"></i> Upload Document
        </a>
    </div>

    <div class="input-group mb-4 w-100 w-lg-50 search-input-group">
        <input type="text" id="SearchVal" class="form-control search-input"
            value="@Model?.CurrentSearch"
            placeholder="Search documents..." />
        <button id="searchBtn" class="btn btn-search-icon">
            <i class="fas fa-search"></i>
        </button>
    </div>

    <div id="partial" class="mt-3">
        <div class="text-center py-5 loading-state">
            <i class="fas fa-spinner fa-spin fa-2x mb-3 text-accent"></i>
            <p class="text-muted">Loading documents...</p>
        </div>
    </div>

    <div class="modal fade" id="editDocumentModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content modal-custom">
                <div class="modal-header">
                    <h5 class="modal-title">Edit Document</h5>
                    <button type="button" class="btn p-0 border-0 bg-transparent close-btn" data-bs-dismiss="modal">
                        <span style="font-size: 1.8rem; line-height: 1; color: var(--text);">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form id="editDocForm">
                        <input type="hidden" id="editDocId" name="Id" />
                        <label class="form-label fw-semibold">Document Name</label>
                        <input type="text" id="editDocName" name="Name" class="form-control modal-input" required />
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="submit" form="editDocForm" class="btn btn-primary btn-custom-accent">Save</button>
                    <button type="button" class="btn btn-secondary modal-secondary-btn" data-bs-dismiss="modal">Cancel</button>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>
        let sortField = "@Model?.SortField";
        let sortOrder = "@Model?.SortOrder";

        function LoadDocuments(pageNum = 1) {
            let SearchVal = $("#SearchVal").val();

            $.ajax({
                url: "/Document/Index",
                type: "GET",
                data: {
                    folderId: "@Model?.FolderId",
                    searchName: SearchVal,
                    pageNum: pageNum,
                    sortField: sortField,
                    sortOrder: sortOrder
                },
                success: function (result) {
                    $("#partial").html(result);
                },
                error: function () {
                    $("#partial").html('<div class="text-danger text-center">Failed to load documents.</div>');
                }
            });
        }

        $(document).ready(function () {
            LoadDocuments();

            $("#SearchVal").on("input", function () {
                LoadDocuments();
            });

            $("#searchBtn").click(function () {
                LoadDocuments();
            });

            $(document).on("click", ".pagination a", function (e) {
                e.preventDefault();
                LoadDocuments($(this).data("pagenum"));
            });

            $(document).on("click", ".sort-link", function (e) {
                e.preventDefault();

                const field = $(this).data("field");
                // const currentOrder = sortField === field && sortOrder === "asc" ? "asc" : "desc";

                // Toggle order if clicking same field again
                sortOrder = (sortField === field && sortOrder === "asc") ? "desc" : "asc";
                sortField = field;

                LoadDocuments();
            });


            // partial
            $(document).on("click", ".edit-doc-btn", function () {
                $("#editDocId").val($(this).data("id"));
                $("#editDocName").val($(this).data("name"));
                $("#editDocumentModal").modal("show");
            });

            $(document).on("submit", "#editDocForm", function (e) {
                e.preventDefault();

                let formData = new FormData(this);

                $.ajax({
                    url: "/Document/EditModal",
                    type: "POST",
                    contentType: false,
                    processData: false,
                    data: formData,
                    success: function (response) {
                        if(response.success){
                            const modalEl = document.getElementById('editDocumentModal');
                            const modal = bootstrap.Modal.getInstance(modalEl) || new bootstrap.Modal(modalEl);
                            modal.hide();

                            Swal.fire({
                                icon: 'success',
                                title: response.message,
                                timer: 1500,
                                showConfirmButton: false
                            });

                            LoadDocuments();
                        }else {
                            Swal.fire({
                                icon: 'warning',
                                title: response.message,
                                timer: 1500,
                                showConfirmButton: true
                            });
                        }
                    },
                    error: function () {
                        Swal.fire('Error!', 'Could not update document.', 'error');
                    }
                });
            });

            $(document).on("click", "tr[data-url]", function(e) {
                if(!$(e.target).closest("button, a , form").length){
                    window.open($(this).data("url"), "_self");
                }
            });

            $(document).on("click", ".delete-button", function(e){

                e.preventDefault();
                const btn = $(this);
                const form = btn.closest('form');
                const docId = form.data('id');

                Swal.fire({
                    title: 'Are you sure?',
                    text: "This document will be moved to trash.",
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#d33',
                    cancelButtonColor: '#3085d6',
                    confirmButtonText: 'Yes, delete it!'
                }).then((result) => {

                    if(result.isConfirmed){

                        $.ajax({
                            url: form.attr("action"),
                            type: 'POST',
                            data: form.serialize(),
                            success: function(){

                                Swal.fire(
                                    'Deleted!',
                                    'Document has been deleted.',
                                    'success'
                                );

                                $("#doc-row-" + docId).fadeOut(300, function(){
                                    $(this).remove();
                                });
                                LoadDocuments();
                            },

                            error:  function () {
                                Swal.fire(
                                    'Error!',
                                    'Something went wrong. Please try again.',
                                    'error'
                                );
                            }
                        });
                    }
                });
            });

            $(document).on("click", '.star-toggle-button', function (e) {

                e.preventDefault();

                const button = $(this);
                const form = button.closest('form');
                const isStarred = form.data('starred') === true || form.data('starred') === 'true';

                const docId = form.data('id');
                const action = isStarred ? 'unstar' : 'star';
                const title = isStarred ? 'Unstar this document?' : 'Star this document?';
                const confirmText = isStarred ? 'Yes, unstar it!' : 'Yes, star it!';
                const successMsg = isStarred ? 'Document unstarred.' : 'Document starred.';

                Swal.fire({
                    title: title,
                    icon: 'question',
                    showCancelButton: true,
                    confirmButtonText: confirmText,
                    cancelButtonText: 'Cancel',
                    confirmButtonColor: isStarred ? '#6c757d' : '#f1c40f', // grey or yellow
                    cancelButtonColor: '#999'

                }).then((result) => {

                    if (result.isConfirmed) {

                        $.ajax({
                            url: form.attr('action'),
                            type: 'POST',
                            data: form.serialize(),
                            success: function () {

                                Swal.fire({
                                    icon: 'success',
                                    title: successMsg,
                                    timer: 1500,
                                    showConfirmButton: false
                                });

                                // Toggle state
                                const newAction = isStarred ? 'Star' : 'UnStar';
                                const newTitle = isStarred ? 'Star' : 'Unstar';

                                // Update form
                                form.attr('action', `/Document/${newAction}?id=${docId}`);
                                form.data('starred', !isStarred);

                                // Update button
                                const icon = button.find('i');
                                if (isStarred) {
                                    icon.removeClass('fas text-warning').addClass('far text-muted');
                                } else {
                                    icon.removeClass('far text-muted').addClass('fas text-warning');
                                }
                                button.attr('title', newTitle);
                            },

                            error: function () {
                                Swal.fire('Error!', 'Could not update document star status.', 'error');
                            }
                        });
                    }
                });
            });
        });

    </script>
}

<style>

    :root {
        --bg: #f8f9fa; 
        --sidebar-bg: #ffffff; 
        --text: #212529; 
        --text-muted: #6c757d; 
        --border: #dee2e6; 
        --accent: #007bff; 
        --hover-bg: #f1f1f1;
        --shadow-sm: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
    }
    .dark-theme {
        --bg: #212529;
        --sidebar-bg: #2b3035;
        --text: #e2e6ea;
        --text-muted: #adb5bd;
        --border: #495057;
        --accent: #0d6efd; 
        --hover-bg: #343a40;
        --shadow-sm: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.4);
    }

    .container-fluid {
        background-color: var(--bg);
        color: var(--text);
    }

    .header-area {
        border-color: var(--border) !important;
    }

    .page-title a {
        color: var(--text);
        transition: color 0.2s;
    }

    .page-title a:hover {
        color: var(--accent) !important;
    }

    .btn-upload-doc {
        background-color: var(--accent);
        border-color: var(--accent);
        color: white;
        transition: background-color 0.2s, border-color 0.2s;
    }

    .btn-upload-doc:hover {
        background-color: var(--accent);
        border-color: var(--accent);
        opacity: 0.9;
    }

    .search-input-group {
        max-width: 500px; 
    }

    .search-input {
        background-color: var(--sidebar-bg);
        color: var(--text);
        border: 1px solid var(--border);
    }

    .search-input::placeholder {
        color: var(--text-muted);
        opacity: 0.7;
    }

    .search-input:focus {
        background-color: var(--sidebar-bg);
        color: var(--text);
        border-color: var(--accent);
        box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25); 
    }

    .btn-search-icon {
        background-color: var(--hover-bg); 
        color: var(--text-muted);
        border: 1px solid var(--border);
        border-left: none; 
        transition: background-color 0.2s, color 0.2s;
    }

    .btn-search-icon:hover {
        background-color: var(--accent);
        color: white;
        border-color: var(--accent);
    }

    .loading-state {
        color: var(--text-muted) !important;
    }

    .loading-state i {
        color: var(--accent) !important;
    }

    .modal-custom {
        background-color: var(--sidebar-bg);
        color: var(--text);
        border: 1px solid var(--border);
        box-shadow: var(--shadow-sm);
    }

    .modal-custom .modal-header {
        border-color: var(--border);
    }

    .modal-custom .modal-footer {
        border-color: var(--border);
    }

    .modal-input {
        background-color: var(--bg);
        color: var(--text);
        border-color: var(--border);
    }

    .modal-input:focus {
        background-color: var(--bg);
        border-color: var(--accent);
        box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
    }

    .btn-custom-accent {
        background-color: var(--accent);
        border-color: var(--accent);
        color: white;
    }

    .modal-secondary-btn {
        background-color: var(--text-muted);
        border-color: var(--text-muted);
        color: white;
    }

    @@media (min-width: 992px) {
        .w-lg-50 {
            width: 50% !important;
        }
    }
</style>

