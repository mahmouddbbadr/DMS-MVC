@model DocumentIndexViewModel

<div class="container-fluid mt-4">

    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h4 text-primary mb-0">
            <a asp-controller="Sharing" asp-action="SharedWithMe">
                <i class="fas fa-folder-open me-2"></i> @Model.FolderName Documents
            </a>
        </h1>
        @if(Model.Permission == DMS.Domain.ENums.PermissionLevel.ReadWrite)
        {          
            <a asp-action="Upload" asp-route-folderId="@Model.FolderId" class="btn btn-success">
                <i class="fas fa-upload me-1"></i> Upload Document
            </a>
        }else
        {
            <h3>Read Only Folder</h3>
        }
    </div>

    <!-- Search -->
    <div class="input-group mb-3 w-50">
        <input type="text" id="SearchVal" class="form-control" value="@Model?.CurrentSearch" placeholder="Search documents..." />
        <button id="searchBtn" class="btn btn-outline-secondary">
            <i class="fas fa-search"></i>
        </button>
    </div>

    <!-- Results -->
    <div id="partial" class="mt-3">
        <div class="text-center text-muted py-5">
            <i class="fas fa-spinner fa-spin fa-2x mb-3"></i>
            <p>Loading documents...</p>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>

        let sortField = "@Model?.SortField";
        let sortOrder = "@Model?.SortOrder";

        function LoadDocuments(pageNum = 1) {
            let SearchVal = $("#SearchVal").val();

            $.ajax({
                url: "/Sharing/Folder",
                type: "GET",
                data: {
                    folderId: "@Model?.FolderId",
                    searchName: SearchVal,
                    pageNum: pageNum,
                    sortField: sortField,
                    sortOrder: sortOrder
                },
                success: function (result) {
                    $("#partial").html(result);
                },
                error: function () {
                    $("#partial").html('<div class="text-danger text-center">Failed to load documents.</div>');
                }
            });
        }

        $(document).ready(function () {
            LoadDocuments();

            $("#SearchVal").on("input", function () {
                LoadDocuments();
            });

            $("#searchBtn").click(function () {
                LoadDocuments();
            });

            $(document).on("click", ".pagination a", function (e) {
                e.preventDefault();
                LoadDocuments($(this).data("pagenum"));
            });
            
            $(document).on("click", ".sort-link", function (e) {
                e.preventDefault();

                const field = $(this).data("field");
                // const currentOrder = sortField === field && sortOrder === "asc" ? "asc" : "desc";

                // Toggle order if clicking same field again
                sortOrder = (sortField === field && sortOrder === "asc") ? "desc" : "asc";
                sortField = field;

                LoadDocuments();
            });


            // partial
            $(document).on("click", ".edit-doc-btn", function () {
                $("#editDocId").val($(this).data("id"));
                $("#editDocName").val($(this).data("name"));
                $("#editDocumentModal").modal("show");
            });

            $(document).on("submit", "#editDocForm", function (e) {
                e.preventDefault();

                let formData = new FormData(this);

                $.ajax({
                    url: "/Document/EditModal",
                    type: "POST",
                    contentType: false,
                    processData: false,
                    data: formData,
                    success: function (response) {
                        const modalEl = document.getElementById('editDocumentModal');
                        const modal = bootstrap.Modal.getInstance(modalEl) || new bootstrap.Modal(modalEl);
                        modal.hide();

                        Swal.fire({
                            icon: 'success',
                            title: 'Saved Successfully!',
                            timer: 1500,
                            showConfirmButton: false
                        });

                        LoadDocuments();
                    },

                    error: function () {
                        Swal.fire('Error!', 'Could not update document.', 'error');
                    }
                });
            });

            $(document).on("click", "tr[data-url]", function(e) {
                if(!$(e.target).closest("button, a , form").length){
                    window.open($(this).data("url"), "_self");
                }
            });

            $(document).on("click", ".delete-button", function(e){

                e.preventDefault();
                const btn = $(this);
                const form = btn.closest('form');
                const docId = form.data('id');

                Swal.fire({
                    title: 'Are you sure?',
                    text: "This document will be moved to trash.",
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#d33',
                    cancelButtonColor: '#3085d6',
                    confirmButtonText: 'Yes, delete it!'
                }).then((result) => {

                    if(result.isConfirmed){

                        $.ajax({
                            url: form.attr("action"),
                            type: 'POST',
                            data: form.serialize(),
                            success: function(){

                                Swal.fire(
                                    'Deleted!',
                                    'Document has been deleted.',
                                    'success'
                                );

                                $("#doc-row-" + docId).fadeOut(300, function(){
                                    $(this).remove();
                                });
                                LoadDocuments();
                            },

                            error:  function () {
                                Swal.fire(
                                    'Error!',
                                    'Something went wrong. Please try again.',
                                    'error'
                                );
                            }
                        });
                    }
                });
            });

        });

    </script>
}
